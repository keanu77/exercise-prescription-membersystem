name: Database Backup

on:
  # æ¯å¤©å‡Œæ™¨ 2:00 (UTC) è‡ªå‹•åŸ·è¡Œå‚™ä»½
  schedule:
    - cron: '0 2 * * *'  # æ¯å¤© 02:00 UTC (å°åŒ—æ™‚é–“ 10:00 AM)

  # æ‰‹å‹•è§¸ç™¼å‚™ä»½
  workflow_dispatch:
    inputs:
      retention_days:
        description: 'å‚™ä»½ä¿ç•™å¤©æ•¸'
        required: false
        default: '30'

jobs:
  backup:
    name: Backup Database
    runs-on: ubuntu-latest

    steps:
    # 1. Checkout ç¨‹å¼ç¢¼
    - name: ðŸ“¥ Checkout repository
      uses: actions/checkout@v4

    # 2. è¨­å®š MySQL å®¢æˆ¶ç«¯
    - name: ðŸ”§ Setup MySQL Client
      run: |
        sudo apt-get update
        sudo apt-get install -y mysql-client

    # 3. åŸ·è¡Œè³‡æ–™åº«å‚™ä»½
    - name: ðŸ”’ Backup Database
      env:
        DATABASE_URL: ${{ secrets.DATABASE_URL }}
        RETENTION_DAYS: ${{ github.event.inputs.retention_days || '30' }}
      run: |
        echo "ðŸ”„ é–‹å§‹å‚™ä»½è³‡æ–™åº«..."
        bash scripts/backup/db-backup.sh

    # 4. ä¸Šå‚³å‚™ä»½åˆ° GitHub Artifacts
    - name: ðŸ“¤ Upload Backup to Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: database-backup-${{ github.run_number }}
        path: backups/*.sql.gz
        retention-days: 30  # GitHub Artifacts ä¿ç•™ 30 å¤©

    # 5. å‚™ä»½æ‘˜è¦
    - name: ðŸ“Š Backup Summary
      run: |
        echo "## ðŸ”’ Database Backup Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Backup Information" >> $GITHUB_STEP_SUMMARY
        echo "- **Date:** $(date '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
        echo "- **Workflow Run:** #${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Retention:** 30 days" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Backup Files" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        ls -lh backups/*.sql.gz 2>/dev/null || echo "No backup files found"
        ls -lh backups/*.sql.gz >> $GITHUB_STEP_SUMMARY 2>/dev/null || echo "No backup files" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Download Backup" >> $GITHUB_STEP_SUMMARY
        echo "Backup files are available in the **Artifacts** section of this workflow run." >> $GITHUB_STEP_SUMMARY
        echo "They will be retained for 30 days." >> $GITHUB_STEP_SUMMARY

    # 6. å‚™ä»½å¤±æ•—é€šçŸ¥ï¼ˆå¯é¸ï¼‰
    - name: âš ï¸ Backup Failed Notification
      if: failure()
      run: |
        echo "âŒ Database backup failed!"
        echo "Please check the workflow logs for details."
        echo ""
        echo "## âŒ Backup Failed" >> $GITHUB_STEP_SUMMARY
        echo "The database backup process encountered an error." >> $GITHUB_STEP_SUMMARY
        echo "Please review the workflow logs for more information." >> $GITHUB_STEP_SUMMARY

  # å¯é¸ï¼šé©—è­‰å‚™ä»½æª”æ¡ˆ
  verify:
    name: Verify Backup
    runs-on: ubuntu-latest
    needs: backup
    if: success()

    steps:
    - name: ðŸ“¥ Download Backup
      uses: actions/download-artifact@v4
      with:
        name: database-backup-${{ github.run_number }}
        path: ./backups

    - name: ðŸ” Verify Backup File
      run: |
        echo "ðŸ” é©—è­‰å‚™ä»½æª”æ¡ˆ..."

        # æª¢æŸ¥å‚™ä»½æª”æ¡ˆæ˜¯å¦å­˜åœ¨
        if ls backups/*.sql.gz 1> /dev/null 2>&1; then
          echo "âœ… å‚™ä»½æª”æ¡ˆå­˜åœ¨"

          # æª¢æŸ¥æª”æ¡ˆå¤§å°ï¼ˆæ‡‰è©²å¤§æ–¼ 1KBï¼‰
          for file in backups/*.sql.gz; do
            SIZE=$(stat -f%z "$file" 2>/dev/null || stat -c%s "$file")
            if [ "$SIZE" -gt 1024 ]; then
              echo "âœ… æª”æ¡ˆå¤§å°æ­£å¸¸: $(basename $file) ($SIZE bytes)"
            else
              echo "âŒ æª”æ¡ˆå¤ªå°ï¼Œå¯èƒ½å‚™ä»½å¤±æ•—: $(basename $file) ($SIZE bytes)"
              exit 1
            fi

            # æ¸¬è©¦ gzip æª”æ¡ˆå®Œæ•´æ€§
            if gzip -t "$file"; then
              echo "âœ… å£“ç¸®æª”æ¡ˆå®Œæ•´æ€§æ­£å¸¸"
            else
              echo "âŒ å£“ç¸®æª”æ¡ˆæå£ž"
              exit 1
            fi
          done
        else
          echo "âŒ æ‰¾ä¸åˆ°å‚™ä»½æª”æ¡ˆ"
          exit 1
        fi

        echo ""
        echo "## âœ… Backup Verification Passed" >> $GITHUB_STEP_SUMMARY
        echo "All backup files are valid and intact." >> $GITHUB_STEP_SUMMARY
